<div class="bg-white shadow-md rounded-lg p-6 mb-6">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Loan Details</h2>

  <div class="space-y-4">
    <!-- Loan Number -->
    <div class="flex items-start">
      <p class="text-sm font-bold text-gray-500 w-1/3">Loan Number:</p>
      <p class="text-lg font-medium text-gray-800"><%= loan.data["account"] || "N/A" %></p>
    </div>

    <!-- Branch Address -->
    <div class="flex items-start">
      <p class="text-sm font-bold text-gray-500 w-1/3">Branch Address:</p>
      <p class="text-lg font-medium text-gray-800"><%= loan.dig("branch", "formattedAddress") || "N/A" %></p>
    </div>

    <!-- Loan Amount -->
    <div class="flex items-start">
      <p class="text-sm font-bold text-gray-500 w-1/3">Loan Amount:</p>
      <p class="text-lg font-medium text-gray-800">$<%= number_with_precision(loan.dig("financials", "amount"), precision: 2) || "N/A" %></p>
    </div>

    <!-- Construction Progress -->
    <div class="flex items-start">
      <p class="text-sm font-bold text-gray-500 w-1/3">Construction Progress:</p>
      <p class="text-lg font-medium text-gray-800"><%= loan["constructionProgress"] ? "#{(loan['constructionProgress'] * 100).round(2)}%" : "N/A" %></p>
    </div>
  </div>
</div>

<div class="space-y-6">
  <!-- Loan Funded vs Remaining -->
  <div class="flex items-start">
    <p class="text-sm font-bold text-gray-500 w-1/3">Loan Funded vs Remaining:</p>
    <p class="text-lg font-medium text-gray-800">
      $<%= number_with_precision(loan.dig("financials", "loanFundedAmount"), precision: 2) || "N/A" %>
      Funded / $<%= number_with_precision(loan.dig("financials", "loanBalanceRemaining"), precision: 2) || "N/A" %> Remaining
    </p>
  </div>

  <!-- Available for Construction -->
  <div class="flex items-start">
    <p class="text-sm font-bold text-gray-500 w-1/3">Available for Construction:</p>
    <p class="text-lg font-medium text-gray-800">
      $<%= number_with_precision(loan.dig("financials", "amountAvailableForConstruction"), precision: 2) || "N/A" %>
    </p>
  </div>

  <!-- Amount Drawn to Date -->
  <div class="flex items-start">
    <p class="text-sm font-bold text-gray-500 w-1/3">Amount Drawn to Date:</p>
    <p class="text-lg font-medium text-gray-800">
      $<%= number_with_precision(loan.dig("financials", "drawnToDate"), precision: 2) || "N/A" %>
    </p>
  </div>

  <!-- Retainage Amount -->
  <div class="flex items-start">
    <p class="text-sm font-bold text-gray-500 w-1/3">Retainage Amount:</p>
    <p class="text-lg font-medium text-gray-800">
      $<%= number_with_precision(loan.dig("financials", "retainageAmount"), precision: 2) || "N/A" %>
    </p>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <!-- Loan Amount Chart -->
  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Loan Amount Overview</h3>
    <canvas id="loanAmountChart"></canvas>
  </div>

  <!-- Construction Progress Chart -->
  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Construction Progress</h3>
    <canvas id="constructionProgressChart"></canvas>
  </div>

  <!-- Financial Breakdown Chart -->
  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Financial Breakdown</h3>
    <canvas id="financialBreakdownChart"></canvas>
  </div>

  <!-- Loan Balance vs Funded Chart -->
  <div class="bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Loan Balance vs Funded Amount</h3>
    <canvas id="loanBalanceChart"></canvas>
  </div>
</div>

<script>
  const loanData = <%= raw @loan.to_json %>;  // Pass loan data from the controller

  // Loan Amount Chart (Pie chart for Loan Funded vs Remaining)
  const loanAmountChart = new Chart(document.getElementById('loanAmountChart'), {
    type: 'pie',
    data: {
      labels: ['Loan Funded', 'Loan Remaining'],
      datasets: [{
        label: 'Loan Amount',
        data: [
          loanData.financials.loanFundedAmount || 0,
          loanData.financials.loanBalanceRemaining || 0
        ],
        backgroundColor: ['#4CAF50', '#FF5722'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top'
        }
      }
    }
  });

  // Construction Progress Chart (Bar chart)
  const constructionProgressChart = new Chart(document.getElementById('constructionProgressChart'), {
    type: 'bar',
    data: {
      labels: ['Construction Progress'],
      datasets: [{
        label: 'Progress',
        data: [loanData.constructionProgress * 100 || 0],  // Showing percentage
        backgroundColor: '#2196F3',
        borderColor: '#2196F3',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100
        }
      }
    }
  });

  // Financial Breakdown Chart (Doughnut chart)
  const financialBreakdownChart = new Chart(document.getElementById('financialBreakdownChart'), {
    type: 'doughnut',
    data: {
      labels: ['Available for Construction', 'Drawn Amount', 'Remaining Balance'],
      datasets: [{
        data: [
          loanData.financials.amountAvailableForConstruction || 0,
          loanData.financials.drawnToDate || 0,
          loanData.financials.loanBalanceRemaining || 0
        ],
        backgroundColor: ['#FFEB3B', '#8BC34A', '#FF5722'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top'
        }
      }
    }
  });

  // Loan Balance vs Funded Chart (Line chart)
  const loanBalanceChart = new Chart(document.getElementById('loanBalanceChart'), {
    type: 'line',
    data: {
      labels: ['Loan Funded', 'Loan Remaining'],
      datasets: [{
        label: 'Loan Balance vs Funded',
        data: [
          loanData.financials.loanFundedAmount || 0,
          loanData.financials.loanBalanceRemaining || 0
        ],
        borderColor: '#4CAF50',
        backgroundColor: 'rgba(76, 175, 80, 0.2)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top'
        }
      }
    }
  });
</script>
